<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GoCast Admin</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-primary: #0a0a0f;
                --bg-secondary: #12121a;
                --bg-card: rgba(255, 255, 255, 0.03);
                --bg-glass: rgba(255, 255, 255, 0.05);
                --border-color: rgba(255, 255, 255, 0.08);
                --text-primary: #ffffff;
                --text-secondary: #a0a0b0;
                --text-muted: #606070;
                --accent-cyan: #00d4ff;
                --accent-blue: #00add8;
                --accent-purple: #a855f7;
                --accent-green: #22c55e;
                --accent-red: #ef4444;
                --accent-orange: #f97316;
                --accent-gradient: linear-gradient(
                    135deg,
                    #00d4ff 0%,
                    #00add8 100%
                );
                --glow-cyan: 0 0 30px rgba(0, 212, 255, 0.3);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .bg-gradient {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background:
                    radial-gradient(
                        ellipse at 20% 20%,
                        rgba(0, 212, 255, 0.08) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse at 80% 80%,
                        rgba(0, 173, 216, 0.08) 0%,
                        transparent 50%
                    );
                z-index: -1;
            }

            /* Header */
            .header {
                background: var(--bg-glass);
                backdrop-filter: blur(20px);
                border-bottom: 1px solid var(--border-color);
                padding: 1rem 2rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .header-content {
                max-width: 1400px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .logo-svg {
                height: 40px;
                width: auto;
            }

            .header-status {
                display: flex;
                align-items: center;
                gap: 1.5rem;
            }

            .status-badge {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 0.5rem 1rem;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 20px;
                font-size: 0.85rem;
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--accent-green);
                animation: pulse-dot 2s ease-in-out infinite;
            }

            .status-dot.offline {
                background: var(--accent-red);
                animation: none;
            }

            @keyframes pulse-dot {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* Main Content */
            .main {
                flex: 1;
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
                width: 100%;
            }

            /* Stats Grid */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 16px;
                padding: 1.5rem;
                transition: all 0.3s ease;
            }

            .stat-card:hover {
                border-color: var(--accent-cyan);
                box-shadow: var(--glow-cyan);
            }

            .stat-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                margin-bottom: 1rem;
                background: var(--accent-gradient);
            }

            .stat-label {
                font-size: 0.85rem;
                color: var(--text-muted);
                margin-bottom: 0.5rem;
            }

            .stat-value {
                font-family: "JetBrains Mono", monospace;
                font-size: 2rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            /* Content Grid */
            .content-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 1.5rem;
            }

            .panel {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 16px;
                overflow: hidden;
            }

            .panel-header {
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .panel-title {
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .panel-body {
                padding: 1rem;
            }

            /* Mount Cards */
            .mount-card {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1.25rem;
                margin-bottom: 1rem;
                transition: border-color 0.3s ease;
            }

            .mount-card:last-child {
                margin-bottom: 0;
            }

            .mount-card.live {
                border-color: var(--accent-green);
            }

            .mount-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1rem;
            }

            .mount-name {
                font-family: "JetBrains Mono", monospace;
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--accent-cyan);
            }

            .mount-status {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .mount-status.live {
                background: rgba(34, 197, 94, 0.2);
                color: var(--accent-green);
            }

            .mount-status.offline {
                background: rgba(239, 68, 68, 0.2);
                color: var(--accent-red);
            }

            .mount-meta {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .mount-meta-item {
                text-align: center;
            }

            .mount-meta-value {
                font-family: "JetBrains Mono", monospace;
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .mount-meta-label {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            /* Visualizer */
            .visualizer {
                display: flex;
                align-items: flex-end;
                justify-content: center;
                gap: 3px;
                height: 32px;
                margin-bottom: 1rem;
            }

            .visualizer-bar {
                width: 4px;
                background: var(--accent-gradient);
                border-radius: 2px;
                animation: visualizer 0.5s ease-in-out infinite alternate;
            }

            .visualizer-bar:nth-child(1) {
                height: 40%;
                animation-delay: 0s;
            }
            .visualizer-bar:nth-child(2) {
                height: 70%;
                animation-delay: 0.1s;
            }
            .visualizer-bar:nth-child(3) {
                height: 50%;
                animation-delay: 0.2s;
            }
            .visualizer-bar:nth-child(4) {
                height: 90%;
                animation-delay: 0.3s;
            }
            .visualizer-bar:nth-child(5) {
                height: 60%;
                animation-delay: 0.4s;
            }
            .visualizer-bar:nth-child(6) {
                height: 80%;
                animation-delay: 0.5s;
            }
            .visualizer-bar:nth-child(7) {
                height: 45%;
                animation-delay: 0.6s;
            }
            .visualizer-bar:nth-child(8) {
                height: 65%;
                animation-delay: 0.7s;
            }

            @keyframes visualizer {
                0% {
                    transform: scaleY(0.5);
                }
                100% {
                    transform: scaleY(1);
                }
            }

            .visualizer.paused .visualizer-bar {
                animation: none;
                height: 20%;
                opacity: 0.3;
            }

            /* Now Playing */
            .now-playing {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                background: var(--bg-card);
                border-radius: 8px;
                margin-bottom: 1rem;
            }

            .now-playing-icon {
                font-size: 1.25rem;
            }

            .now-playing-text {
                flex: 1;
                min-width: 0;
            }

            .now-playing-label {
                font-size: 0.7rem;
                color: var(--text-muted);
                text-transform: uppercase;
            }

            .now-playing-title {
                font-size: 0.9rem;
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .mount-genre {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-bottom: 0.75rem;
            }

            /* Buttons */
            .mount-actions {
                display: flex;
                gap: 0.5rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
            }

            .btn-primary {
                background: var(--accent-gradient);
                color: white;
            }

            .btn-primary:hover {
                box-shadow: var(--glow-cyan);
            }

            .btn-secondary {
                background: var(--bg-glass);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }

            .btn-secondary:hover {
                border-color: var(--accent-cyan);
            }

            .btn-danger {
                background: rgba(239, 68, 68, 0.2);
                color: var(--accent-red);
                border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .btn-danger:hover {
                background: rgba(239, 68, 68, 0.3);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Activity Log */
            .log-container {
                max-height: 300px;
                overflow-y: auto;
            }

            .log-entry {
                display: flex;
                gap: 0.75rem;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--border-color);
                font-size: 0.8rem;
            }

            .log-entry:last-child {
                border-bottom: none;
            }

            .log-time {
                font-family: "JetBrains Mono", monospace;
                color: var(--text-muted);
                flex-shrink: 0;
            }

            .log-type {
                padding: 0.1rem 0.4rem;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .log-type.connect {
                background: rgba(34, 197, 94, 0.2);
                color: var(--accent-green);
            }
            .log-type.disconnect {
                background: rgba(239, 68, 68, 0.2);
                color: var(--accent-red);
            }
            .log-type.source {
                background: rgba(0, 212, 255, 0.2);
                color: var(--accent-cyan);
            }
            .log-type.info {
                background: rgba(160, 160, 176, 0.2);
                color: var(--text-secondary);
            }

            /* Footer */
            .footer {
                background: var(--bg-glass);
                border-top: 1px solid var(--border-color);
                padding: 1.5rem 2rem;
                margin-top: auto;
            }

            .footer-content {
                max-width: 1400px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .footer-logo {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .footer-logo svg {
                height: 24px;
                width: auto;
            }

            .footer-text {
                font-size: 0.8rem;
                color: var(--text-muted);
            }

            .footer-links {
                display: flex;
                gap: 1.5rem;
            }

            .footer-link {
                font-size: 0.8rem;
                color: var(--text-secondary);
                text-decoration: none;
                transition: color 0.2s ease;
            }

            .footer-link:hover {
                color: var(--accent-cyan);
            }

            .footer-version {
                font-family: "JetBrains Mono", monospace;
                font-size: 0.75rem;
                color: var(--text-muted);
                padding: 0.25rem 0.5rem;
                background: var(--bg-card);
                border-radius: 4px;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
                .content-grid {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 640px) {
                .stats-grid {
                    grid-template-columns: 1fr;
                }
                .header-content {
                    flex-direction: column;
                    gap: 1rem;
                }
                .footer-content {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 3px;
            }
        </style>
    </head>
    <body>
        <div class="bg-gradient"></div>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg
                        class="logo-svg"
                        viewBox="0 0 200 50"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <defs>
                            <linearGradient
                                id="logoGrad"
                                x1="0%"
                                y1="0%"
                                x2="100%"
                                y2="100%"
                            >
                                <stop offset="0%" stop-color="#00D4FF" />
                                <stop offset="100%" stop-color="#00ADD8" />
                            </linearGradient>
                        </defs>
                        <circle
                            cx="20"
                            cy="25"
                            r="18"
                            fill="none"
                            stroke="url(#logoGrad)"
                            stroke-width="2"
                        />
                        <g transform="translate(20, 25)">
                            <polygon
                                points="-3,10 3,10 5,-5 -5,-5"
                                fill="url(#logoGrad)"
                            />
                            <circle cx="0" cy="-8" r="3" fill="#00D4FF" />
                            <path
                                d="M-8,-3 Q-12,-10 -8,-17"
                                fill="none"
                                stroke="#00D4FF"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                opacity="0.8"
                            />
                            <path
                                d="M8,-3 Q12,-10 8,-17"
                                fill="none"
                                stroke="#00D4FF"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                opacity="0.8"
                            />
                        </g>
                        <text
                            x="50"
                            y="32"
                            font-family="'JetBrains Mono', monospace"
                            font-size="24"
                            font-weight="700"
                            fill="#00ADD8"
                        >
                            GoCast
                        </text>
                    </svg>
                </div>
                <div class="header-status">
                    <div class="status-badge">
                        <div class="status-dot" id="serverStatus"></div>
                        <span id="serverStatusText">Connecting...</span>
                    </div>
                    <div class="status-badge">
                        <span>‚è±Ô∏è</span>
                        <span id="uptime">00:00:00</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total Listeners</div>
                    <div class="stat-value" id="totalListeners">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì°</div>
                    <div class="stat-label">Active Mounts</div>
                    <div class="stat-value" id="activeMounts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Peak Listeners</div>
                    <div class="stat-value" id="peakListeners">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">Bandwidth (KB/s)</div>
                    <div class="stat-value" id="bandwidth">0</div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Mounts Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span>üìª</span> Mount Points
                        </h2>
                    </div>
                    <div class="panel-body" id="mountsContainer">
                        <div class="mount-card">
                            <p
                                style="
                                    text-align: center;
                                    color: var(--text-muted);
                                    padding: 2rem;
                                "
                            >
                                Loading...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Activity Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <span>üìã</span> Activity Log
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="log-container" id="activityLog">
                            <div class="log-entry">
                                <span class="log-time">--:--:--</span>
                                <span>Waiting for events...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient
                                id="footerGrad"
                                x1="0%"
                                y1="0%"
                                x2="100%"
                                y2="100%"
                            >
                                <stop offset="0%" stop-color="#00D4FF" />
                                <stop offset="100%" stop-color="#00ADD8" />
                            </linearGradient>
                        </defs>
                        <circle
                            cx="20"
                            cy="20"
                            r="18"
                            fill="none"
                            stroke="url(#footerGrad)"
                            stroke-width="1.5"
                        />
                        <g transform="translate(20, 20)">
                            <polygon
                                points="-2.5,8 2.5,8 4,-4 -4,-4"
                                fill="url(#footerGrad)"
                            />
                            <circle cx="0" cy="-6" r="2.5" fill="#00D4FF" />
                        </g>
                    </svg>
                    <span class="footer-text">GoCast Streaming Server</span>
                </div>
                <div class="footer-links">
                    <a
                        href="https://github.com/AyushGupta45/gocast"
                        class="footer-link"
                        target="_blank"
                        >GitHub</a
                    >
                    <a href="/status" class="footer-link" target="_blank"
                        >Public Status</a
                    >
                    <a
                        href="/status?format=json"
                        class="footer-link"
                        target="_blank"
                        >API</a
                    >
                    <a
                        href="https://github.com/AyushGupta45/gocast/issues"
                        class="footer-link"
                        target="_blank"
                        >Report Issue</a
                    >
                    <a
                        href="https://github.com/AyushGupta45/gocast#readme"
                        class="footer-link"
                        target="_blank"
                        >Documentation</a
                    >
                </div>
                <div class="footer-version" id="serverVersion">v1.0.0</div>
            </div>
        </footer>

        <script>
            // State
            let sessionToken = null;
            let eventSource = null;
            let startTime = Date.now();
            let activityLogs = [];
            let mountsData = {};
            let peakListeners = 0;
            let serverVersion = "1.0.0";

            // Get session token for SSE
            async function getSessionToken() {
                try {
                    const response = await fetch("/admin/token", {
                        method: "GET",
                        credentials: "include",
                    });
                    if (response.ok) {
                        const data = await response.json();
                        sessionToken = data.token;
                        return true;
                    }
                } catch (e) {
                    console.error("Failed to get session token:", e);
                }
                return false;
            }

            // Connect to SSE with token
            async function connectSSE() {
                if (!sessionToken) {
                    const gotToken = await getSessionToken();
                    if (!gotToken) {
                        addLog("info", "Auth failed, using polling mode");
                        startPolling();
                        return;
                    }
                }

                if (eventSource) {
                    eventSource.close();
                }

                eventSource = new EventSource(`/events?token=${sessionToken}`);

                eventSource.onopen = function () {
                    document.getElementById("serverStatus").className =
                        "status-dot";
                    document.getElementById("serverStatusText").textContent =
                        "Connected";
                    addLog("info", "Real-time connection established");
                };

                eventSource.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        // Extract version from server_id (e.g., "GoCast/1.0.0")
                        if (data.server_id) {
                            const match = data.server_id.match(/GoCast\/(.+)/);
                            if (match) {
                                serverVersion = match[1];
                                document.getElementById(
                                    "serverVersion",
                                ).textContent = "v" + serverVersion;
                            }
                        }
                        updateUI(data);
                    } catch (e) {
                        console.error("Failed to parse SSE data:", e);
                    }
                };

                eventSource.onerror = function () {
                    document.getElementById("serverStatus").className =
                        "status-dot offline";
                    document.getElementById("serverStatusText").textContent =
                        "Reconnecting...";
                    eventSource.close();
                    eventSource = null;
                    sessionToken = null;

                    // Retry connection after 3 seconds
                    setTimeout(connectSSE, 3000);
                };
            }

            // Fallback polling
            let pollingInterval = null;
            function startPolling() {
                if (pollingInterval) return;

                pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch("/status?format=json");
                        const data = await response.json();
                        if (data.icestats) {
                            updateUI({ source: data.icestats.source || [] });
                        }
                        document.getElementById("serverStatus").className =
                            "status-dot";
                        document.getElementById(
                            "serverStatusText",
                        ).textContent = "Connected (polling)";
                    } catch (e) {
                        document.getElementById("serverStatus").className =
                            "status-dot offline";
                        document.getElementById(
                            "serverStatusText",
                        ).textContent = "Connection Error";
                    }
                }, 2000);
            }

            // Update UI with new data
            function updateUI(data) {
                const sources = data.source || [];
                let totalListeners = 0;
                let activeMounts = 0;
                let totalBandwidth = 0;

                sources.forEach((source) => {
                    totalListeners += source.listeners || 0;
                    peakListeners = Math.max(
                        peakListeners,
                        source.peak || 0,
                        totalListeners,
                    );

                    if (source.active) {
                        activeMounts++;
                        totalBandwidth +=
                            ((source.listeners || 0) *
                                (source.bitrate || 128)) /
                            8;
                    }

                    // Track changes for activity log
                    const prev = mountsData[source.mount];
                    if (prev) {
                        if (prev.listeners !== source.listeners) {
                            const diff = source.listeners - prev.listeners;
                            if (diff > 0) {
                                addLog(
                                    "connect",
                                    `+${diff} listener(s) on ${source.mount}`,
                                );
                            } else if (diff < 0) {
                                addLog(
                                    "disconnect",
                                    `${Math.abs(diff)} listener(s) left ${source.mount}`,
                                );
                            }
                        }
                        if (!prev.active && source.active) {
                            addLog(
                                "source",
                                `Source connected: ${source.mount}`,
                            );
                        } else if (prev.active && !source.active) {
                            addLog(
                                "source",
                                `Source disconnected: ${source.mount}`,
                            );
                        }
                    }
                    mountsData[source.mount] = { ...source };
                });

                // Update stats
                updateText("totalListeners", totalListeners);
                updateText("activeMounts", activeMounts);
                updateText("peakListeners", peakListeners);
                updateText("bandwidth", Math.round(totalBandwidth));

                // Update mounts
                renderMounts(sources);
            }

            // Update text only if changed
            function updateText(id, value) {
                const el = document.getElementById(id);
                if (el && el.textContent !== String(value)) {
                    el.textContent = value;
                }
            }

            // Render mount cards with in-place updates
            function renderMounts(sources) {
                const container = document.getElementById("mountsContainer");

                if (!sources || sources.length === 0) {
                    container.innerHTML =
                        '<div class="mount-card"><p style="text-align: center; color: var(--text-muted); padding: 2rem;">No mounts configured</p></div>';
                    return;
                }

                // Sort: active first
                sources.sort((a, b) => (b.active ? 1 : 0) - (a.active ? 1 : 0));

                // Get existing cards
                const existingCards = {};
                container
                    .querySelectorAll(".mount-card[data-mount]")
                    .forEach((card) => {
                        existingCards[card.dataset.mount] = card;
                    });

                const seenMounts = new Set();

                sources.forEach((source) => {
                    seenMounts.add(source.mount);
                    let card = existingCards[source.mount];

                    if (card) {
                        updateMountCard(card, source);
                    } else {
                        card = createMountCard(source);
                        container.appendChild(card);
                    }
                });

                // Remove old cards
                Object.keys(existingCards).forEach((mount) => {
                    if (!seenMounts.has(mount)) {
                        existingCards[mount].remove();
                    }
                });

                // Remove loading message
                const loading = container.querySelector(
                    ".mount-card:not([data-mount])",
                );
                if (loading && sources.length > 0) {
                    loading.remove();
                }
            }

            // Create mount card
            function createMountCard(source) {
                const card = document.createElement("div");
                card.className = `mount-card ${source.active ? "live" : ""}`;
                card.dataset.mount = source.mount;

                const nowPlaying = getNowPlaying(source);

                card.innerHTML = `
                <div class="mount-header">
                    <span class="mount-name">${source.mount}</span>
                    <span class="mount-status ${source.active ? "live" : "offline"}">
                        <span class="status-dot ${source.active ? "" : "offline"}"></span>
                        <span class="status-label">${source.active ? "LIVE" : "OFFLINE"}</span>
                    </span>
                </div>
                <div class="visualizer ${source.active ? "" : "paused"}">
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                </div>
                <div class="mount-meta">
                    <div class="mount-meta-item">
                        <div class="mount-meta-value" data-field="listeners">${source.listeners || 0}</div>
                        <div class="mount-meta-label">Listeners</div>
                    </div>
                    <div class="mount-meta-item">
                        <div class="mount-meta-value" data-field="peak">${source.peak || 0}</div>
                        <div class="mount-meta-label">Peak</div>
                    </div>
                    <div class="mount-meta-item">
                        <div class="mount-meta-value" data-field="bitrate">${source.bitrate || 128}</div>
                        <div class="mount-meta-label">Kbps</div>
                    </div>
                </div>
                <div class="now-playing">
                    <span class="now-playing-icon">üéµ</span>
                    <div class="now-playing-text">
                        <div class="now-playing-label">${source.active ? "Now Playing" : "Status"}</div>
                        <div class="now-playing-title" data-field="nowplaying">${source.active ? nowPlaying : "No source connected"}</div>
                    </div>
                </div>
                <div class="mount-genre" data-field="genre" style="display: ${source.genre ? "block" : "none"}">Genre: ${source.genre || ""}</div>
                <div class="mount-actions">
                    <button class="btn btn-secondary btn-listen" ${!source.active ? "disabled" : ""}>‚ñ∂Ô∏è Listen</button>
                    <button class="btn btn-secondary btn-copy">üìã Copy URL</button>
                    <button class="btn btn-danger btn-kill" ${!source.active ? "disabled" : ""}>‚èπÔ∏è Kill</button>
                </div>
            `;

                // Event listeners
                card.querySelector(".btn-listen").onclick = () =>
                    window.open(source.mount, "_blank");
                card.querySelector(".btn-copy").onclick = (e) =>
                    copyToClipboard(location.origin + source.mount, e);
                card.querySelector(".btn-kill").onclick = () =>
                    killSource(source.mount);

                return card;
            }

            // Update mount card in-place
            function updateMountCard(card, source) {
                const isLive = source.active;

                // Update classes
                card.classList.toggle("live", isLive);

                // Update status
                const statusEl = card.querySelector(".mount-status");
                if (statusEl) {
                    statusEl.className = `mount-status ${isLive ? "live" : "offline"}`;
                    const dot = statusEl.querySelector(".status-dot");
                    if (dot)
                        dot.className = `status-dot ${isLive ? "" : "offline"}`;
                    const label = statusEl.querySelector(".status-label");
                    if (label) label.textContent = isLive ? "LIVE" : "OFFLINE";
                }

                // Update visualizer
                const viz = card.querySelector(".visualizer");
                if (viz) viz.classList.toggle("paused", !isLive);

                // Update values
                const fields = {
                    listeners: source.listeners || 0,
                    peak: source.peak || 0,
                    bitrate: source.bitrate || 128,
                    nowplaying: isLive
                        ? getNowPlaying(source)
                        : "No source connected",
                    genre: source.genre || "",
                };

                Object.entries(fields).forEach(([field, value]) => {
                    const el = card.querySelector(`[data-field="${field}"]`);
                    if (el && el.textContent !== String(value)) {
                        el.textContent = value;
                    }
                });

                // Update genre visibility
                const genreEl = card.querySelector(".mount-genre");
                if (genreEl)
                    genreEl.style.display = source.genre ? "block" : "none";

                // Update now playing label
                const npLabel = card.querySelector(".now-playing-label");
                if (npLabel)
                    npLabel.textContent = isLive ? "Now Playing" : "Status";

                // Update buttons
                const listenBtn = card.querySelector(".btn-listen");
                const killBtn = card.querySelector(".btn-kill");
                if (listenBtn) listenBtn.disabled = !isLive;
                if (killBtn) killBtn.disabled = !isLive;
            }

            // Get now playing text
            function getNowPlaying(source) {
                const title = source.title || source.name || "";
                const artist = source.artist || "";
                const album = source.album || "";

                if (!title || title === "Live Stream on " + source.mount) {
                    return "Live Stream";
                }

                let text = title;
                if (artist) {
                    text += ` - ${artist}`;
                }
                if (album) {
                    text += ` (${album})`;
                }
                return text;
            }

            // Kill source
            async function killSource(mount) {
                if (!confirm(`Kill source on ${mount}?`)) return;

                try {
                    const response = await fetch(
                        `/admin/killsource?mount=${encodeURIComponent(mount)}`,
                        {
                            method: "GET",
                            credentials: "include",
                        },
                    );
                    if (response.ok) {
                        addLog("source", `Killed source: ${mount}`);
                    } else {
                        alert("Failed to kill source: " + response.statusText);
                    }
                } catch (e) {
                    alert("Error: " + e.message);
                }
            }

            // Copy to clipboard
            function copyToClipboard(text, e) {
                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        const btn = e.currentTarget;
                        const original = btn.innerHTML;
                        btn.innerHTML = "‚úì Copied!";
                        setTimeout(() => (btn.innerHTML = original), 1500);
                    })
                    .catch(() => {
                        prompt("Copy URL:", text);
                    });
            }

            // Add log entry
            function addLog(type, message) {
                const time = new Date().toTimeString().split(" ")[0];
                activityLogs.unshift({ time, type, message });
                if (activityLogs.length > 50) activityLogs.pop();
                renderLogs();
            }

            // Render logs
            function renderLogs() {
                const container = document.getElementById("activityLog");
                if (activityLogs.length === 0) {
                    container.innerHTML =
                        '<div class="log-entry"><span class="log-time">--:--:--</span><span>No activity yet</span></div>';
                    return;
                }

                container.innerHTML = activityLogs
                    .map(
                        (log) => `
                <div class="log-entry">
                    <span class="log-time">${log.time}</span>
                    <span class="log-type ${log.type}">${log.type}</span>
                    <span>${log.message}</span>
                </div>
            `,
                    )
                    .join("");
            }

            // Update uptime
            function updateUptime() {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const h = String(Math.floor(elapsed / 3600)).padStart(2, "0");
                const m = String(Math.floor((elapsed % 3600) / 60)).padStart(
                    2,
                    "0",
                );
                const s = String(elapsed % 60).padStart(2, "0");
                document.getElementById("uptime").textContent =
                    `${h}:${m}:${s}`;
            }

            // Initialize
            setInterval(updateUptime, 1000);
            connectSSE();
            addLog("info", "Admin panel initialized");
        </script>
    </body>
</html>
